<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>R8 Health Resource Dashboard</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966334.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js" defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-green: rgb(5, 104, 57); --primary-green-dark: rgb(3, 80, 44); }
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f5; color: #1e293b; scroll-behavior: smooth; }
        .container-custom { width: 100%; max-width: 100%; padding: 2rem; }
        .card { @apply bg-white rounded-[2rem] shadow-sm border border-slate-200 p-6 transition-all; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        
        /* DataTable UI */
        table.dataTable { border-collapse: collapse !important; width: 100% !important; border: 1px solid #cbd5e1 !important; border-radius: 1rem; overflow: hidden; }
        table.dataTable thead th { background-color: var(--primary-green) !important; color: white !important; padding: 15px !important; text-align: center !important; }
        table.dataTable tbody td { padding: 12px !important; border: 1px solid #e2e8f0 !important; text-align: center; }
        
        /* Highlight 0 เป็นสีเหลือง */
        .zero-value { background-color: #fef08a !important; color: #854d0e !important; font-weight: bold; }
        .doc-total-cell { background-color: #f0fdf4 !important; font-weight: bold; color: var(--primary-green-dark); }
        
        footer { background-color: var(--primary-green); color: white; @apply py-8 mt-12 text-center; }
        
        /* [แก้ไข] Back to Top Button ให้ลอยและเด่นชัดขึ้น */
        #backToTop {
            @apply fixed bottom-10 right-10 bg-green-600 text-white p-5 rounded-full shadow-[0_15px_30px_rgba(5,104,57,0.4)] border-4 border-white transition-all duration-300 opacity-0 invisible z-[9999];
        }
        #backToTop:hover { @apply bg-green-700 scale-110 shadow-[0_20px_40px_rgba(5,104,57,0.5)]; }
        #backToTop:active { @apply scale-95; }
        #backToTop.show { @apply opacity-100 visible; }
        
        .loading-overlay { @apply fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center transition-opacity duration-300; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700 mb-4"></div>
        <p class="text-green-800 font-bold animate-pulse">กำลังประมวลผลข้อมูลความเร็วสูง...</p>
    </div>

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="container-custom mx-auto px-8 h-24 flex items-center justify-between">
            <div class="flex items-center gap-5">
                <div class="flex items-center gap-3">
                    <div class="bg-green-50 p-2 rounded-2xl shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800 mb-1">R8 Health Resource Dashboard</h1>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Version: <span id="headerVersion"></span></p>
                    </div>
                </div>
            </div>
            <select id="provinceFilter" onchange="processAndRender()" class="bg-slate-50 border border-slate-200 text-slate-700 py-2.5 px-6 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-green-600 shadow-sm cursor-pointer">
                <option value="ALL">ทุกจังหวัดในเขตสุขภาพที่ 8</option>
                <option value="บึงกาฬ">บึงกาฬ</option><option value="หนองบัวลำภู">หนองบัวลำภู</option><option value="อุดรธานี">อุดรธานี</option>
                <option value="เลย">เลย</option><option value="หนองคาย">หนองคาย</option><option value="สกลนคร">สกลนคร</option><option value="นครพนม">นครพนม</option>
            </select>
        </div>
    </nav>

    <main id="mainContent" class="container-custom space-y-10 px-12 flex-grow opacity-0">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="card text-white border-none flex items-center justify-between p-10" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);">
                <div class="flex items-center gap-8">
                    <div class="bg-white/20 p-6 rounded-[2rem] backdrop-blur-md">
                        <svg class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-10V4m0 10V4m-4 11h.01" /></svg>
                    </div>
                    <div><p class="text-sm font-bold opacity-80 uppercase tracking-widest">โรงพยาบาลรวม</p><h2 class="text-6xl font-black"><span id="totalHospitals">0</span> แห่ง</h2></div>
                </div>
            </div>
            <div class="card flex items-center justify-between p-10 border-l-[12px] border-l-green-600">
                <div class="flex items-center gap-8">
                    <div class="bg-green-50 p-6 rounded-[2rem] text-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    </div>
                    <div><p class="text-sm font-bold text-slate-400 uppercase tracking-widest">ประชากรรวม</p><h2 class="text-6xl font-black text-slate-800"><span id="totalPopulation">0</span> คน</h2></div>
                </div>
            </div>
        </div>

        <div id="hospitalCards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6"></div>

        <div class="card p-8"><h3 class="text-xl font-bold mb-8 flex items-center gap-2"><div class="w-2 h-6 bg-green-600 rounded-full"></div>จำนวนโรงพยาบาล จำแนกประเภท รพศ./รพท./รพช.</h3><div class="chart-container"><canvas id="hospTypeChart"></canvas></div></div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <div class="card xl:col-span-1"><h3 class="font-bold mb-6">ประชากรรายจังหวัด</h3><div class="chart-container"><canvas id="popChart"></canvas></div></div>
            <div class="card xl:col-span-1"><h3 class="font-bold mb-6">แพทย์สาขาหลัก</h3><div class="chart-container"><canvas id="coreBarChart"></canvas></div></div>
            <div class="card xl:col-span-1"><h3 class="font-bold mb-6">ระดับ SAP</h3><div class="chart-container"><canvas id="sapChart"></canvas></div></div>
        </div>

        <div class="space-y-4">
            <div class="flex items-center gap-2 px-2"><div class="w-3 h-8 bg-green-700 rounded-full"></div><h3 class="text-xl font-bold">สรุปจำนวนแพทย์สาขาหลักแยกตามความเชี่ยวชาญ</h3></div>
            <div class="custom-table-container bg-white p-4 rounded-3xl shadow-sm overflow-hidden">
                <table id="physicianTable" class="display nowrap cell-border stripe" style="width:100%">
                    <thead><tr><th>จังหวัด</th><th>กุมารแพทย์</th><th>ศัลยแพทย์ OR</th><th>อายุรแพทย์ ICU</th><th>อายุรแพทย์ Stroke</th><th>อายุรแพทย์ HD</th><th>รวมทั้งสิ้น</th></tr></thead>
                    <tbody id="physicianBody"></tbody>
                </table>
            </div>
        </div>

        <div class="space-y-4 pb-20">
            <div class="flex items-center gap-2 px-2"><div class="w-3 h-8 bg-blue-600 rounded-full"></div><h3 class="text-xl font-bold">สรุปจำนวนพยาบาลแยกตามสาขาและจังหวัด</h3></div>
            <div class="custom-table-container bg-white p-4 rounded-3xl shadow-sm overflow-hidden">
                <table id="nurseTable" class="display nowrap cell-border stripe" style="width:100%">
                    <thead><tr id="nurseHeader"></tr></thead>
                    <tbody id="nurseBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'})" title="กลับสู่ด้านบน">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <footer>
        <p class="text-lg font-bold mb-1">สงวนลิขสิทธิ์ © 2569 - ข้อมูลและเนื้อหาทั้งหมด</p>
        <p class="text-sm opacity-80 mb-3">จัดทำโดยกลุ่มงานพัฒนายุทธศาสตร์สาธารณสุข สำนักงานสาธารณสุขจังหวัดเลย</p>
        <div class="bg-white/10 py-1 px-4 rounded-full inline-block text-[11px] font-bold">อัปเดตล่าสุด: <span id="lastUpdated">...</span></div>
    </footer>

    <script>
        const PROVINCES = ['บึงกาฬ', 'หนองบัวลำภู', 'อุดรธานี', 'เลย', 'หนองคาย', 'สกลนคร', 'นครพนม'];
        const PROV_COLORS = { 'บึงกาฬ': '#056839', 'หนองบัวลำภู': '#38A169', 'อุดรธานี': '#2D3748', 'เลย': '#C05621', 'หนองคาย': '#2F855A', 'สกลนคร': '#276749', 'นครพนม': '#2C7A7B' };
        const SAP_GRADES = ['S+', 'S', 'A+', 'A', 'P+', 'P'];
        const SAP_COLORS = { 'S+': '#056839', 'S': '#16a34a', 'A+': '#1d4ed8', 'A': '#3b82f6', 'P+': '#ea580c', 'P': '#f59e0b' };
        let rawData = []; let charts = {};

        function generateVersion() { const now = new Date(); return `${(now.getFullYear()+543).toString().slice(-2)}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-1460`; }
        function cleanNum(val) { if (!val || val === "-" || val === "") return 0; return parseFloat(String(val).replace(/,/g, '')) || 0; }
        function getValClass(val) { return parseFloat(val) === 0 ? 'zero-value' : ''; }

        window.onload = function() {
            document.getElementById('headerVersion').innerText = generateVersion();
            if (typeof google !== 'undefined' && google.script) {
                google.script.run.withSuccessHandler(res => {
                    if (res.status === 'success') {
                        rawData = res.data;
                        document.getElementById('lastUpdated').innerText = new Date().toLocaleString('th-TH');
                        processAndRender();
                        $("#loader").addClass("opacity-0");
                        setTimeout(() => $("#loader").hide(), 300);
                    }
                }).getDashboardData();
            } else {
                // Dummy Data for testing
                rawData = [["","","","","จังหวัด","","","","โรงพยาบาล","ประชากร","ระดับ SAP","แพทย์","แพทย์สาขาหลัก","ทันตแพทย์","เภสัชกร","พยาบาลวิชาชีพ","พยาบาลเทคนิค","พยาบาล NICU","พยาบาล OR ศัลยกรรม","พยาบาล ICU อายุรกแพทย์","พยาบาล Stroke อายุรกแพทย์","พยาบาล HD","กุมารแพทย์","ศัลยแพทย์ OR","อายุรแพทย์ ICU","อายุรแพทย์ Stroke","อายุรแพทย์ HD"]];
                PROVINCES.forEach(p => { for(let i=0; i<10; i++) rawData.push(["","","","",p,"","","","", (i===0?500000:0), (i%2?"P+":"S"), 0, 0,0,0,0,0,0,0,0,0,0, (i%3===0?0:5), 5, 5, 5, 5, "Hosp"]); });
                processAndRender();
                $("#loader").hide();
            }
        };

        function processAndRender() {
            const filter = document.getElementById('provinceFilter').value;
            const headers = rawData[0]; const rows = rawData.slice(1);
            const findIdx = (n) => headers.findIndex(h => h.toString().trim().includes(n));
            const idx = { prov: 4, sap: findIdx("ระดับ SAP"), pop: findIdx("ประชากร"), peds: findIdx("กุมารแพทย์"), surg: findIdx("ศัลยแพทย์ OR"), icu: findIdx("อายุรแพทย์ ICU"), stroke: findIdx("อายุรแพทย์ Stroke"), hd: findIdx("อายุรแพทย์ HD") };
            const nurseIdxs = ["พยาบาลวิชาชีพ", "พยาบาลเทคนิค", "พยาบาล NICU", "พยาบาล OR ศัลยกรรม", "พยาบาล ICU อายุรกรรม", "พยาบาล Stroke อายุรกรรม", "พยาบาล HD"].map(n => ({ label: n, index: findIdx(n) }));

            const stats = {};
            PROVINCES.forEach(p => { stats[p] = { count: 0, pop: 0, docs: { peds:0, surg:0, icu:0, stroke:0, hd:0 }, sap: {}, nurses: {}, types: { รพศ:0, รพท:0, รพช:0 } }; nurseIdxs.forEach(n => stats[p].nurses[n.label] = 0); });

            rows.forEach(r => {
                const prov = String(r[idx.prov] || "").trim();
                if (stats[prov]) {
                    const grade = String(r[idx.sap] || "").trim().toUpperCase();
                    if (grade !== "") {
                        stats[prov].count++;
                        if (grade === "P+") { if (prov === "อุดรธานี" || prov === "สกลนคร") stats[prov].types.รพศ++; else stats[prov].types.รพท++; }
                        else if (grade === "P") { if (prov === "เลย" || prov === "นครพนม" || prov === "สกลนคร") stats[prov].types.รพท++; else stats[prov].types.รพช++; }
                        else if (grade === "A+") stats[prov].types.รพท++;
                        else stats[prov].types.รพช++;
                        if (!stats[prov].sap[grade]) stats[prov].sap[grade] = 0; stats[prov].sap[grade]++;
                    }
                    stats[prov].pop += cleanNum(r[idx.pop]);
                    Object.keys(stats[prov].docs).forEach(k => stats[prov].docs[k] += cleanNum(r[idx[k]]));
                    nurseIdxs.forEach(n => stats[prov].nurses[n.label] += cleanNum(r[n.index]));
                }
            });

            updateUI(stats, filter, nurseIdxs);
        }

        function updateUI(stats, filter, nurseIdxs) {
            const list = filter === 'ALL' ? PROVINCES : [filter];
            document.getElementById('totalHospitals').innerText = list.reduce((s, p) => s + stats[p].count, 0);
            document.getElementById('totalPopulation').innerText = Math.round(list.reduce((s, p) => s + stats[p].pop, 0)).toLocaleString();

            document.getElementById('hospitalCards').innerHTML = PROVINCES.map(p => {
                const isHidden = filter !== 'ALL' && filter !== p;
                return `<div class="card p-6 flex flex-col items-center transition-all ${isHidden?'opacity-30 scale-95 grayscale':''}"><div class="w-2.5 h-2.5 rounded-full mb-3" style="background-color:${PROV_COLORS[p]}"></div><span class="text-xl font-bold text-slate-700 mb-1">${p}</span><span class="text-4xl font-black text-slate-800 tracking-tighter">${stats[p].count}</span><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Hospitals</span></div>`;
            }).join('');

            requestAnimationFrame(() => {
                drawCharts(stats, list, filter);
                updateTables(stats, list, nurseIdxs);
                document.getElementById('mainContent').style.opacity = '1';
            });
        }

        function updateTables(stats, list, nurseIdxs) {
            if ($.fn.DataTable.isDataTable('#physicianTable')) $('#physicianTable').DataTable().destroy();
            if ($.fn.DataTable.isDataTable('#nurseTable')) $('#nurseTable').DataTable().destroy();

            document.getElementById('physicianBody').innerHTML = list.map(p => {
                const d = stats[p].docs; const total = d.peds+d.surg+d.icu+d.stroke+d.hd;
                return `<tr><td>${p}</td><td class="${getValClass(d.peds)}">${d.peds}</td><td class="${getValClass(d.surg)}">${d.surg}</td><td class="${getValClass(d.icu)}">${d.icu}</td><td class="${getValClass(d.stroke)}">${d.stroke}</td><td class="${getValClass(d.hd)}">${d.hd}</td><td class="doc-total-cell">${total}</td></tr>`;
            }).join('');

            document.getElementById('nurseHeader').innerHTML = `<th>จังหวัด</th><th>จำนวน รพ.</th>${nurseIdxs.map(n => `<th>${n.label}</th>`).join('')}<th>รวมทั้งสิ้น</th>`;
            document.getElementById('nurseBody').innerHTML = list.map(p => {
                const total = Object.values(stats[p].nurses).reduce((a,b)=>a+b,0);
                return `<tr><td>${p}</td><td>${stats[p].count}</td>${nurseIdxs.map(n => `<td class="${getValClass(Math.round(stats[p].nurses[n.label]))}">${Math.round(stats[p].nurses[n.label])}</td>`).join('')}<td class="doc-total-cell">${Math.round(total)}</td></tr>`;
            }).join('');

            $('#physicianTable').DataTable({ paging: false, info: false, searching: false, scrollX: true, responsive: true });
            $('#nurseTable').DataTable({ paging: false, info: false, searching: false, scrollX: true, responsive: true });
        }

        function drawCharts(stats, labels, filter) {
            const ctxArr = ['hospTypeChart', 'popChart', 'coreBarChart', 'sapChart'].map(id => document.getElementById(id).getContext('2d'));
            if (charts.hType) charts.hType.destroy();
            if (charts.pop) charts.pop.destroy();
            if (charts.core) charts.core.destroy();
            if (charts.sap) charts.sap.destroy();

            const opt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Sarabun' } } } } };
            charts.hType = new Chart(ctxArr[0], { type: 'bar', data: { labels, datasets: [{ label: 'รพศ.', data: labels.map(l => stats[l].types.รพศ), backgroundColor: '#056839' }, { label: 'รพท.', data: labels.map(l => stats[l].types.รพท), backgroundColor: '#1d4ed8' }, { label: 'รพช.', data: labels.map(l => stats[l].types.รพช), backgroundColor: '#ea580c' }] }, options: opt });
            charts.pop = new Chart(ctxArr[1], { type: 'bar', data: { labels, datasets: [{ label: 'ประชากร', data: labels.map(l => stats[l].pop), backgroundColor: '#056839' }] }, options: opt });
            charts.core = new Chart(ctxArr[2], { type: 'bar', data: { labels, datasets: [{ label: 'รวมแพทย์', data: labels.map(l => Object.values(stats[l].docs).reduce((a,b)=>a+b,0)), backgroundColor: '#16a34a' }] }, options: opt });
            charts.sap = new Chart(ctxArr[3], { type: 'bar', data: { labels, datasets: SAP_GRADES.map(g => ({ label: g, data: labels.map(l => stats[l].sap[g] || 0), backgroundColor: SAP_COLORS[g] })) }, options: { ...opt, scales: { x: { stacked: true }, y: { stacked: true } } } });
        }

        window.onscroll = function() { const btn = document.getElementById("backToTop"); if (window.scrollY > 400) btn.classList.add("show"); else btn.classList.remove("show"); };
    </script>
</body>
</html>
